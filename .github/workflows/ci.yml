name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run type check
        run: bun run tsc --noEmit

      - name: Run linter
        run: bunx @biomejs/biome check .

      - name: Run tests
        run: bun test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build binary
        run: |
          bun build --compile --minify src/cli.ts --outfile claude-mem
          ls -lh claude-mem

  version-preview:
    name: Version Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Preview Version Bump
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          # Get commits in this PR (not in base branch)
          echo "ðŸ“¦ Version Bump Preview"
          echo "========================"
          echo ""
          echo "Commits in this PR:"
          git log origin/$BASE_REF..HEAD --oneline
          echo ""

          # Analyze PR commits for version bump
          COMMITS=$(git log origin/$BASE_REF..HEAD --format="%s")

          HAS_BREAKING=false
          HAS_FEAT=false
          HAS_FIX=false

          while IFS= read -r msg; do
            if [[ "$msg" =~ ^[a-z]+!: ]] || [[ "$msg" == *"BREAKING CHANGE"* ]]; then
              HAS_BREAKING=true
            fi
            if [[ "$msg" =~ ^feat(\(.+\))?: ]]; then
              HAS_FEAT=true
            fi
            if [[ "$msg" =~ ^(fix|docs|chore|refactor|test|style|perf|ci|build)(\(.+\))?: ]]; then
              HAS_FIX=true
            fi
          done <<< "$COMMITS"

          # Determine bump type
          if $HAS_BREAKING; then
            BUMP="major"
          elif $HAS_FEAT; then
            BUMP="minor"
          elif $HAS_FIX; then
            BUMP="patch"
          else
            BUMP="none"
          fi

          CURRENT_VERSION=$(jq -r '.version' package.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case $BUMP in
            major) NEW_VERSION="$((MAJOR + 1)).0.0" ;;
            minor) NEW_VERSION="$MAJOR.$((MINOR + 1)).0" ;;
            patch) NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
            *) NEW_VERSION="$CURRENT_VERSION" ;;
          esac

          echo "Bump type: $BUMP"
          echo "Version: $CURRENT_VERSION â†’ $NEW_VERSION"

          # Add to summary
          {
            echo "## ðŸ“¦ Version Bump Preview"
            echo ""
            echo "**Commits in this PR:**"
            echo '```'
            git log origin/$BASE_REF..HEAD --oneline
            echo '```'
            echo ""
            echo "| Current | Bump | New |"
            echo "|---------|------|-----|"
            echo "| $CURRENT_VERSION | $BUMP | $NEW_VERSION |"
          } >> $GITHUB_STEP_SUMMARY
